---
sidebar_position: 3
title: "Architecture"
---

import Tooltip from '@site/src/components/Tooltip';

# Architecture

## System Overview

The <Tooltip content="The on-chain smart contract protocol.">Nitrolite</Tooltip> protocol architecture consists of multiple layers working together to enable scalable, secure <Tooltip content="A secure communication pathway between participants that locks funds in an on-chain smart contract while enabling off-chain state updates.">state channel</Tooltip> operations:

```mermaid
graph TB

  %% Layered architecture with legible fills for light/dark modes

  subgraph Application["Application Layer"]
    direction TB
    APP["Chess, DEX, Gaming, Payments, Custom Logic"]
  end

  subgraph OffChain["Off-Chain Layer (Fast Updates)"]
    direction LR
    CLIENT["Client SDK"]
    BROKER["Broker (Clearnode)"]
  end

  subgraph OnChain["On-Chain Layer (Smart Contracts)"]
    direction TB
    CONTRACTS["Custody / App Contracts"]
  end

  subgraph Blockchain["Blockchain Layer"]
    direction TB
    CHAIN["Ethereum, Polygon, etc."]
  end

  APP --> CLIENT
  APP --> BROKER
  CLIENT <-->|"Nitro RPC (WebSocket)"| BROKER
  CLIENT -. "Checkpoint / Settle" .-> CONTRACTS
  BROKER -. "Join / Verify" .-> CONTRACTS
  CONTRACTS --> CHAIN

  %% Subgraph fills (kept light for both themes)
  style Application fill:#e1f5ff,stroke:#9ad7ff,color:#111
  style OffChain fill:#fff4e1,stroke:#ffd497,color:#111
  style OnChain fill:#ffe1f5,stroke:#ffbde6,color:#111
  style Blockchain fill:#f0f0f0,stroke:#c9c9c9,color:#111

  %% Emphasize the RPC link (index 2 in the edge list above)
  linkStyle 2 stroke:#0ea5e9,stroke-width:2px
```

## Communication Patterns

### Channel Opening

The <Tooltip content="A secure communication pathway between participants that locks funds in an on-chain smart contract while enabling off-chain state updates.">channel</Tooltip> opening process follows a coordinated sequence between client and <Tooltip content="A virtual ledger layer that provides a unified ledger (through Nitro RPC) and coordinates state channels (through Nitrolite), providing chain abstraction for developers and users.">a clearnode</Tooltip>:

1. Client requests channel creation from <Tooltip content="A virtual ledger layer that provides a unified ledger (through Nitro RPC) and coordinates state channels (through Nitrolite), providing chain abstraction for developers and users.">a clearnode</Tooltip> via <Tooltip content="The off-chain communication protocol.">Nitro RPC</Tooltip>
2. The clearnode returns signed initial <Tooltip content="A snapshot of the channel at a point in time, including fund allocations and application-specific data.">state</Tooltip> (signature at index 1)
3. Client signs the initial <Tooltip content="A snapshot of the channel at a point in time, including fund allocations and application-specific data.">state</Tooltip> (signature at index 0)
4. Client submits transaction to <Tooltip content="The underlying distributed ledger technology (e.g., Ethereum).">blockchain</Tooltip> with both signatures
5. Contract verifies signatures and emits `Opened` event
6. Channel becomes ACTIVE immediately
7. The clearnode monitors the `Opened` event and updates its internal state

```mermaid
sequenceDiagram
    participant Client
    participant Clearnode
    participant Blockchain
    
    Client->>Clearnode: create_channel request
    Clearnode->>Client: signed initial state (clearnode signature)
    Client->>Client: Add own signature
    Client->>Blockchain: create() with BOTH signatures
    Blockchain->>Blockchain: Verify signatures<br/>Set status = ACTIVE
    Blockchain->>Blockchain: Emit Opened event
    Blockchain-->>Clearnode: Opened event (monitored)
    Clearnode->>Client: channel_update notification
```

:::success Cooperative Opening
Channel opening requires cooperation between both parties, ensuring mutual agreement before funds are locked.
:::

### Off-Chain Updates

**Off-Chain Updates**:

1. <Tooltip content="An entity (identified by a wallet address) that is part of a channel.">Participants</Tooltip> exchange signed <Tooltip content="A snapshot of the channel at a point in time, including fund allocations and application-specific data.">state</Tooltip> updates via <Tooltip content="The off-chain communication protocol.">Nitro RPC</Tooltip>

   - *Note for <Tooltip content="Off-chain channels built on top of payment channels, intended to be used by app developers to enable application-specific interactions and transactions without touching the blockchain.">App Sessions</Tooltip>*: The exchange of states is handled by the App itself. Once the App Session state has enough signatures to satisfy quorum, a responsible party submits this signed state to the <Tooltip content="A virtual ledger layer that provides a unified ledger (through Nitro RPC) and coordinates state channels (through Nitrolite), providing chain abstraction for developers and users.">Clearnode</Tooltip>.

2. No blockchain transactions required

3. Latest valid state maintained off-chain

4. Can be checkpointed on-chain at any time

   - *Current Implementation Note*: While this is the ideal design goal, the current implementation does not store off-chain state that is not related to on-chain state, so checkpointing is not currently supported. This functionality is under development and will be more enforced in the next version of the protocol.

:::tip Zero Gas Fees
Off-chain updates are instant (< 1 second) and incur zero gas fees, enabling high-frequency operations.
:::

### Channel Closing

Channels can be closed in two ways:

**Cooperative Closure**:
1. All participants sign final state
2. Any participant closes on-chain with signed final state
3. Fast and gas-efficient (1 transaction)

**Non-Cooperative Closure**:
1. Challenge-response mechanism resolves disputes
2. Requires challenge period for security
3. More expensive but works when parties disagree

```mermaid
graph LR
    A[Active Channel] --> B{Parties Agree?}
    B -->|Yes| C[Cooperative Close<br/>Fast, Cheap]
    B -->|No| D[Challenge-Response<br/>Slow, Secure]
    
    style C fill:#90EE90,stroke:#333,color:#111
    style D fill:#FFB6C1,stroke:#333,color:#111
```

## Fund Flow

The following diagram illustrates how funds flow through the Nitrolite protocol:

```mermaid
graph TB
    A[User Wallet<br/>ERC-20] -->|deposit| B[Custody Contract<br/>Available]
    B -->|create/resize| C[Channel<br/>Locked]
    C -->|off-chain updates| D[Unified Balance<br/>Clearnode]
    D -->|open/deposit| E[App Sessions<br/>Application]
    E -->|close session| D
    D -->|close channel| B
    B -->|withdraw| A
    
    style A fill:#90EE90,stroke:#333,color:#111
    style B fill:#87CEEB,stroke:#333,color:#111
    style C fill:#FFD700,stroke:#333,color:#111
    style D fill:#DDA0DD,stroke:#333,color:#111
    style E fill:#FFA07A,stroke:#333,color:#111
```

**Flow Explanation**:

1. **Deposit**: User deposits ERC-20 tokens into <Tooltip content="The main on-chain contract implementing channel creation, joining, and closure.">Custody Contract</Tooltip>
2. **Lock**: Funds move from "available" to "locked" when <Tooltip content="A secure communication pathway between participants that locks funds in an on-chain smart contract while enabling off-chain state updates.">channel</Tooltip> is created/joined
3. **Off-Chain**: Locked funds become part of <Tooltip content="An abstraction that aggregates a user's funds across multiple blockchain networks, managed by Clearnode.">unified balance</Tooltip>, managed off-chain
4. **App Sessions**: Funds can be allocated to <Tooltip content="Off-chain channels built on top of payment channels, intended to be used by app developers to enable application-specific interactions and transactions without touching the blockchain.">app sessions</Tooltip> for applications
5. **Release**: When app sessions close, funds return to unified balance
6. **Unlock**: When channel closes, funds return to custody "available" balance
7. **Withdraw**: User withdraws funds back to their wallet

:::caution Security Guarantee
At every stage, funds remain cryptographically secured. Users can always recover their funds according to the latest valid signed state, even if the clearnode becomes unresponsive.
:::

